<!DOCTYPE html>
<!--[if lt IE 8 ]><html class="no-js ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="no-js ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 8)|!(IE)]><!--><html class="no-js" lang="en"> <!--<![endif]-->
<head>

  <meta charset="utf-8">
  <meta content="" name="description">

  <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport">

  <link href="/advent/theme/css/default.css" rel="stylesheet">
  <link href="/advent/theme/css/layout.css" rel="stylesheet">
  <link href="/advent/theme/css/media-queries.css" rel="stylesheet">
  <link href="/advent/theme/css/statocles.css" rel="stylesheet">

  <!-- twitter and opengraph -->
  <meta content="summary" name="twitter:card">
  <meta content="https://pdl.perl.org/advent/blog/2024/12/15/pitch-detection/" property="og:url">
  <meta content="Day 15: Pitch detection" property="og:title">
    <meta content="An explanation of (part of) Praat&#39;s pitch detection algorithm using PDL
" property="og:description">
    <meta content="https://pdl.perl.org/advent/banner.jpg" property="og:image">
    <meta content="summary_large_image" name="twitter:card">

  <script src="/advent/theme/js/modernizr.js"></script>

      <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/sunburst.min.css" rel="stylesheet">

  <title>Day 15: Pitch detection - PDL Advent calendar 2024</title>
  <meta content="José Joaquín Atria" name="author">
  <meta content="Statocles 0.098" name="generator">
  <link href="/advent/../images/favicon.ico" rel="shortcut icon">
  
  
</head>

<body>

   <header>

      <div class="row">

         <div class="twelve columns">


            <nav id="nav-wrap">

              <a class="mobile-btn" href="#nav-wrap" title="Show navigation">Show navigation</a>
              <a class="mobile-btn" href="#" title="Hide navigation">Hide navigation</a>

               <ul class="nav" id="nav">
                 <!-- li.current is given a different styling -->
                   <li><a href="/advent/../">PDL Website</a></li>
                   <li><a href="/advent/blog">Blog</a></li>
                   <li><a href="/advent/blog/index.rss"><i class="fa fa-rss"></i></a></li>

               </ul>

            </nav>

         </div>

      </div>

   </header>

   

<div class="content-outer">

  <div class="row" id="page-content">

      <div class="eight columns" id="primary">

        <article class="post">

            <div class="entry-header cf">

              <h1>Day 15: Pitch detection</h1>

              <p class="post-meta">

                  <time class="date" datetime="2024-12-15">Dec 15, 2024</time>
                  

              </p>

            </div>

              <div class="post-thumb">
                <!-- theme suggests 1300x500 -->
                <img alt="A close up of a person&#39;s ear" src="banner.jpg">
              </div>

            <div class="post-content">

              <section id="section-1">
                  <p>In a previous life I spent most of my time (free and otherwise) thinking about
phonetics and the analysis of speech sounds. Like most scientific research, it
was slow and tedious and oddly rewarding.</p>

<p>Back then I was already in a steady drift towards spending more time playing
with computers than with my research, so a lot of my efforts went into
studying <a href="https://www.fon.hum.uva.nl/praat">Praat</a>, a piece of software you&#39;ve
almost certainly never heard of, but that has probably been used in most of
the phonetics research you&#39;ve also never heard of.</p>

              </section>
              <section id="section-2">
                  <p>One of Praat&#39;s biggest claims to fame is its <a href="https://www.fon.hum.uva.nl/praat/manual/FAQ__Pitch_analysis.html">pitch detection algorithm</a>,
which does a remarkably good job at estimating the <a href="https://en.wikipedia.org/wiki/Fundamental_frequency">fundamental frequency</a>
(or f₀) of speech sounds. This is essential for any kind of research on the
intonation of spoken languages (called &quot;prosody&quot;), and it is difficult for
primarily two reasons:</p>

<ol>
<li><p>Speech sounds are made of a combination of several harmonic frequencies,
which makes the task not just about frequency detection, but about
detecting the right one.</p></li>
<li><p>Speech sounds change rapidly, so we have only a small amount of unstable
data for any frequency at any point in time.</p></li>
</ol>

<p>Praat&#39;s algorithm corrects for these by making a number of assumptions about
the sounds it deals with, most of which are tied to the fact that speech
sounds are generated by the human vocal tract. So, for example, while speech
sounds change all the time, there is a limit to how quickly the vocal tract
can make those changes, which means that on a small enough time scale, we
should be able to treat speech sounds as if they were stable. Praat refers
to these windows of analysis as &quot;frames&quot;.</p>

<p>This article (which is based on <a href="https://pinguinorodriguez.cl/blog/pitch-in-praat">a similar one</a> I wrote in 2012 using R) will
go over the core part of the algorithm as described in <a href="http://www.fon.hum.uva.nl/paul/papers/Proceedings_1993.pdf">Boersma (1993)</a>, and
since this is the PDL Advent Calendar, we&#39;ll be using PDL for illustrating
each step and generating the figures. I&#39;ll be showing the relevant bits of
code at each step, but you can also download <a href="./pitch-detection.pl">a file with all of the code</a> in
context.</p>

<p>The plots in this article have also been plotted with PDL using
<a href="https://metacpan.org/pod/PDL::Graphics::Gnuplot">PDL::Graphics::Gnuplot</a>. In the interest of clarity, I won&#39;t show here the
code used to generate them, but always remember that all of it is available
in <a href="./pitch-detection.pl">the file I just mentioned</a>.</p>

<p>To represent our speech sound we&#39;ll use a complex sinewave with two frequency
components: one at 140Hz to represent our fundamental frequency, and one to
represent a loud harmonic an octave higher at 280Hz. In this case, our frame
is long enough to hold three periods.</p>

<pre><code>my $f0 = 140;
my $sampling_rate = 44100;
my $periods_per_frame = 3;

my $samples = ( 1 / $f0 ) * $sampling_rate * $periods_per_frame;
my $x = sequence $samples;

# A complex sine wave with a component at the desired target frequency
my $wave = 1 + 0.3 * sin( 2 * PI * $f0 * $x / $sampling_rate );

# with a loud component an octave higher
$wave *= sin( 2 * PI * ( 2 * $f0 ) * $x / $sampling_rate );

# normalised to a range of -1 .. 1
$wave /= max $wave;
</code></pre>

<p></p><figure>
 <figcaption>The sound in the analysis window</figcaption>
 <img alt="Three cycles of a complex sine wave, with a peak amplitude of 1 and
  starting and ending at 0. The horizontal axis is 945 samples long" src="./figure-1.svg">
</figure>

<p>In this case the analysis window perfectly lines up with the zero-crossings of
the wave, which means we don&#39;t have any intensity peaks at the edges. But this
is not guaranteed to happen, so to avoid this the first thing we&#39;ll do is
filter the window.</p>

<p>Different filters will have different effects on the analysis, and indeed
Praat can be configured to use either a <a href="https://en.wikipedia.org/wiki/Hann_function">Hann</a> or a <a href="https://en.wikipedia.org/wiki/Gaussian_function">Gaussian</a> window. The one
used by default is the Hann window (which is referred to as &quot;Hanning&quot; in the
article and by Praat), so that&#39;s the one we&#39;ll use in this article.</p>

<p>So if we assume for example that we are only interested in frequencies above
120Hz, and we are going with <em>at least</em> three periods per frame, we&#39;ll need a
window that is at least 3 * ( 1 / 120 ) or 0.025 seconds long.</p>

<p>To calculate the Hann window, we can use <a href="https://metacpan.org/pod/PDL::DSP::Windows">PDL::DSP::Windows</a>:</p>

<pre><code>my $filter = window $samples, &#39;hann&#39;;
</code></pre>

<p></p><figure>
 <figcaption>The Hann filter function</figcaption>
 <img alt="A Hann filter, tracing a bell curve asymptotically approaching 0 on
  both ends" src="./figure-2.svg">
</figure>

<p>And we apply this filter to our sound wave by multiplying both curves:</p>

<pre><code>my $filtered = $wave * $filter;
</code></pre>

<p></p><figure>
 <figcaption>The filtered window</figcaption>
 <img alt="A Hann-filtered complex sine wave, with an amplitude close to 0 on
  each end and 1 in the middle" src="./figure-3.svg">
</figure>

<p>So far this has mostly been preparing our data, but now we come to the meat
and potatoes of the process.</p>

<p>To detect a sound&#39;s pitch Praat uses <a href="https://en.wikipedia.org/wiki/Autocorrelation">autocorrelation</a>, comparing each frame with
itself. An autocorrelation plot shows the degree to which the compared curves are
related on the Y-axis, and the time lag for each comparison on the X-axis. If
the curve is periodic, then the autocorrelation curve should have a peak when the
lag is equal to the original curve&#39;s period.</p>

<p>We can calculate the wave&#39;s autocorrelation with the <code>acf</code> method provided by
importing <a href="https://metacpan.org/pod/PDL::Stats::TS">PDL::Stats::TS</a>. Since we are not providing any arguments, the
number of lags will default to one less than the number of samples in the
ndarray, which is exactly what we want:</p>

<pre><code>my $filtered_acf = $filtered-&gt;acf;
</code></pre>

<p></p><figure>
 <figcaption>Normalised autocorrelation of the filtered sound</figcaption>
 <img alt="An autocorrelation plot with the Y-axis ranging from 1 to -1, showing a
  series of peaks with decreasing intensities. The line starts at the top and
  falls back and up again with a first peak on sample 157, and a second
  smaller peak on sample 316" src="./figure-4.svg">
</figure>

<p>The autocorrelation is highest at a time lag of 0, when the curve is being
compared with itself, so we need to look for peaks that are greater than 0 for
significant periodicity. However, in this case, since we are working with a
complex sound wave with a loud harmonic, the autocorrelation curve shows a
&quot;false&quot; peak before the time lag that we know is the sound&#39;s actual
fundamental frequency, which is aligned with a lower peak.</p>

<p>In order to correct for this, Boersma&#39;s algorithm divides the filtered signal
by what it describes as the normalised autocorrelation curve of the window
function, which is calculated as follows:</p>

<pre><code>my $filter_acf
    = ( 1 - ( abs($x) / $samples ) )
    * ( 2 / 3 + 1 / 3 * cos( 2 * PI * $x / $samples ) )
    + ( 1 / ( 2 * PI ) )
    * sin( ( 2 * PI * abs($x) ) / $samples );
</code></pre>

<p></p><figure>
 <figcaption>Normalised autocorrelation of the window function</figcaption>
 <img alt="Half of a bell curve, starting from 1 and curving downwards to the right,
  asymptotically approaching 0 in the end" src="./figure-5.svg">
</figure>

<p>The result of dividing the autocorrelation of the filtered sample and that of
the filter is an estimate of the autocorrelation of the original signal, which
Boersma claims to be both robust and better suited for the analysis of speech
signals than previous methods used.</p>

<p>Note that this estimate gets increasingly unreliable after roughly half the
length of the analysis window, so the algorithm discards any data in the
second half (<a href="http://www.fon.hum.uva.nl/paul/papers/Proceedings_1993.pdf">Boersma, 1993</a>).</p>

<pre><code>my $estimated_acf = $filtered_acf / $filter_acf;

# Discard second half
my $slice = int $samples / 2;
$estimated_acf-&gt;slice( &quot;$slice:&quot; ) .= nan;

# Normalise to -1 ... 1 range
$estimated_acf /= max $estimated_acf;
</code></pre>

<p></p><figure>
 <figcaption>Estimated autocorrelation of the original signal</figcaption>
 <img alt="Three cycles of a sinusoid wave, half the length of the ones shown
  before, starting on a peak at a magnitude of 1. The second peak is slightly
  lower than the first. The third peak, which is slightly higher than the
  second, is marked with a blue line on sample 316" src="./figure-6.svg">
</figure>

<p>By finding the maximum at a time lag greater than zero in this curve, we can
get an estimate of the pitch of the original signal converting from samples
back to Hz:</p>

<pre><code>my ($index) = @{ ( 20 + $estimated_acf-&gt;slice(&#39;21:&#39;)-&gt;maximum_ind )-&gt;unpdl };
my $foo = $index / $sampling_rate;
my $result = 1 / ( $index / $sampling_rate );
say &quot;f0 = $result&quot;;
# OUTPUT: f0 = 140.445859872611
</code></pre>

<p>This covers equations 5 through 9 of those described in <a href="http://www.fon.hum.uva.nl/paul/papers/Proceedings_1993.pdf">Boersma (1993)</a>, but
it is far from the entire algorithm. This part is used to calculate pitch
&quot;candidates&quot;. We have not covered here some of the preprocessing done to the
sound before separating it into individual frames, or the path finding that is
later done on the pitch candidates to trace a final pitch curve, but this is
probably a good place to stop for now.</p>

              </section>
              <section id="section-3">
                  <ul>
<li>Boersma, P. (1993) <em>Accurate short-term analysis of the fundamental
frequency and the harmonics-to-noise ratio of a sampled sound</em>.
IFA Proceedings 17: 97-110</li>
</ul>

              </section>
              <small><p><a href="https://www.pexels.com/photo/close-up-photo-of-a-person-s-ear-8092973/">Close-Up Photo of a Person&#39;s Ear</a> Image Credit: Kaboompics.com, <a href="https://www.pexels.com/license/">free to use</a></p>
</small>

              <p class="tags">
                <span>Tagged in </span>:
                  <a href="/advent/blog/tag/signal-processing/">signal processing</a>,
                  <a href="/advent/blog/tag/phonetics/">phonetics</a>,
                  <a href="/advent/blog/tag/speech/">speech</a>
              </p>


                  <div class="bio cf">

                      <div class="gravatar">
                        <img alt="author image" src="https://secure.gravatar.com/avatar/5c8db490df81736445eee4097def2bc9">
                      </div>
                      <div class="about">
                        <h5>José Joaquín Atria</h5>
                        <p>José Joaquín had a previous life as a Speech Scientist before he decided to move full time towards software development. He has released a number of <a href="https://metacpan.org/author/JJATRIA">Perl</a> and <a href="https://raku.land/zef:jjatria">Raku</a> distributions, and likes to give conference talks about them when he can.</p>

                      </div>

                  </div>

              <ul class="post-nav cf">
                  <li class="prev"><a href="/advent/blog/2024/12/14/stats/index.html" rel="prev"><strong>Previous Article</strong> Day 14: Getting started with Statistics</a></li>
              </ul>

            </div>

        </article>


      </div>

      <div class="four columns end" id="secondary">
        <aside id="sidebar">
          







<div class="widget widget_tag_cloud">
  <h5 class="widget-title">Tags</h5>
  <div class="tagcloud cf">
    <a href="/advent/blog/tag/bad-values/">Bad Values</a>
    <a href="/advent/blog/tag/cartography/">cartography</a>
    <a href="/advent/blog/tag/clustering/">clustering</a>
    <a href="/advent/blog/tag/correlation/">correlation</a>
    <a href="/advent/blog/tag/csv/">CSV</a>
    <a href="/advent/blog/tag/d3-js/">D3.js</a>
    <a href="/advent/blog/tag/data-analysis/">data analysis</a>
    <a href="/advent/blog/tag/finance/">finance</a>
    <a href="/advent/blog/tag/installation/">installation</a>
    <a href="/advent/blog/tag/interpolation/">interpolation</a>
    <a href="/advent/blog/tag/introduction/">introduction</a>
    <a href="/advent/blog/tag/macos/">MacOS</a>
    <a href="/advent/blog/tag/mojolicious/">Mojolicious</a>
    <a href="/advent/blog/tag/nan/">NaN</a>
    <a href="/advent/blog/tag/optimisation/">optimisation</a>
    <a href="/advent/blog/tag/phonetics/">phonetics</a>
    <a href="/advent/blog/tag/plotting/">plotting</a>
    <a href="/advent/blog/tag/random-graph/">random graph</a>
    <a href="/advent/blog/tag/random-numbers/">random numbers</a>
    <a href="/advent/blog/tag/scipdl/">SciPDL</a>
    <a href="/advent/blog/tag/signal-processing/">signal processing</a>
    <a href="/advent/blog/tag/significance/">significance</a>
    <a href="/advent/blog/tag/simplex/">simplex</a>
    <a href="/advent/blog/tag/slicing/">slicing</a>
    <a href="/advent/blog/tag/sound/">sound</a>
    <a href="/advent/blog/tag/speech/">speech</a>
    <a href="/advent/blog/tag/statistics/">statistics</a>
    <a href="/advent/blog/tag/transform/">transform</a>
    <a href="/advent/blog/tag/trid/">TriD</a>
    <a href="/advent/blog/tag/unsupervised-learning/">unsupervised learning</a>
    <a href="/advent/blog/tag/visualisation/">visualisation</a>
    <a href="/advent/blog/tag/visualization/">visualization</a>
  </div>
</div>



        </aside>
      </div>

   </div>

</div>


   <footer>

      <div class="row">

         <div class="twelve columns">

            <ul class="footer-nav">
                <li><a href="/advent/../">PDL Website</a></li>
                <li><a href="/advent/blog">Blog</a></li>
                <li><a href="/advent/blog/index.rss"><i class="fa fa-rss"></i></a></li>
            </ul>


            <ul class="copyright">
               <li>Design by <a href="http://www.styleshout.com/">Styleshout</a></li>
               <li>Made with <a href="http://preaction.me/statocles">Statocles</a></li>
               <li>Powered by <a href="http://www.perl.org">Perl</a></li>
            </ul>

         </div>

         <div id="go-top" style="display: block;"><a href="#" title="Back to Top">Go To Top</a></div>

      </div>

   </footer>

   <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
   <script>window.jQuery || document.write('<script src="/theme/js/jquery-1.10.2.min.js"><\/script>')</script>
   <script src="/advent/theme/js/jquery-migrate-1.2.1.min.js" type="text/javascript"></script>

   <script src="/advent/theme/js/jquery.flexslider.js"></script>
   <script src="/advent/theme/js/doubletaptogo.js"></script>
   <script src="/advent/theme/js/init.js"></script>

      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/perl.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/xml.min.js"></script>
      <script>
        hljs.configure({"languages":["perl","bash","yaml","xml"]});
        hljs.initHighlightingOnLoad();
      </script>


</body>

</html>
